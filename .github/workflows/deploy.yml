name: üöÄ Deploy Spinza.io Smart Contract

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'devnet'
        type: choice
        options:
        - devnet
        - mainnet-beta

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üßπ NUCLEAR CLEAN
      run: |
        echo "üßπ NUCLEAR CLEAN - Removing EVERYTHING..."
        sudo apt-get remove -y rustc cargo || true
        sudo apt-get autoremove -y || true
        rustup self uninstall -y || true
        rm -rf ~/.rustup ~/.cargo /usr/local/cargo /usr/local/rustup || true
        sudo rm -rf /usr/bin/rustc /usr/bin/cargo || true
        
    - name: ü¶Ä NUCLEAR RUST INSTALL
      run: |
        echo "üì¶ NUCLEAR Rust installation..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.77.0 --profile minimal
        source ~/.cargo/env
        
        # FORCE update PATH globally
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
        echo 'export RUSTUP_HOME="$HOME/.rustup"' >> ~/.bashrc
        echo 'export CARGO_HOME="$HOME/.cargo"' >> ~/.bashrc
        source ~/.bashrc
        
        # Verify NUCLEAR installation
        ~/.cargo/bin/rustc --version
        ~/.cargo/bin/cargo --version
        
    - name: ‚ö° Install Solana CLI
      run: |
        source ~/.cargo/env
        echo "Installing Solana CLI..."
        cd /tmp
        wget https://github.com/solana-labs/solana/releases/download/v1.18.0/solana-release-x86_64-unknown-linux-gnu.tar.bz2
        tar -xjf solana-release-x86_64-unknown-linux-gnu.tar.bz2
        mkdir -p ~/.local/share/solana/install/active_release
        cp -r solana-release/* ~/.local/share/solana/install/active_release/
        chmod +x ~/.local/share/solana/install/active_release/bin/*
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        ~/.local/share/solana/install/active_release/bin/solana --version
        
    - name: ‚öì Install Anchor CLI
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.cargo/bin:$PATH"
        npm install -g @coral-xyz/anchor-cli@0.30.0
        anchor --version
        
    - name: üîë Setup Solana Keypair
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        mkdir -p ~/.config/solana
        echo '${{ secrets.SOLANA_PRIVATE_KEY }}' > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        ~/.local/share/solana/install/active_release/bin/solana config set --url ${{ github.event.inputs.environment || 'devnet' }}
        
    - name: üí∞ Fund Wallet
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        echo "Wallet: $(~/.local/share/solana/install/active_release/bin/solana address)"
        if [ "${{ github.event.inputs.environment || 'devnet' }}" = "devnet" ]; then
          ~/.local/share/solana/install/active_release/bin/solana airdrop 2 || echo "Airdrop failed"
          sleep 5
        fi
        
    - name: üî® NUCLEAR BUILD (BACK TO WORKING)
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.cargo/bin:$PATH"
        export RUSTUP_HOME="$HOME/.rustup"
        export CARGO_HOME="$HOME/.cargo"
        
        echo "üîç FINAL VERIFICATION:"
        echo "rustc: $(which rustc) -> $(rustc --version)"
        echo "cargo: $(which cargo) -> $(cargo --version)"
        
        # BACK TO WORKING BUILD - let Anchor handle the target
        ~/.cargo/bin/cargo --version
        CARGO_NET_GIT_FETCH_WITH_CLI=true ~/.cargo/bin/cargo build --release --manifest-path programs/spinza/Cargo.toml
        
    - name: üöÄ Deploy Smart Contract (FINAL NUCLEAR SEARCH)
      run: |
        echo "FINAL NUCLEAR - Checking Solana CLI installation..."
        
        # CHECK INSIDE SOLANA CLI DIRECTORY
        echo "üîç CHECKING SOLANA CLI DIRECTORY:"
        find ~/.local/share/solana -name "rustc" -type f 2>/dev/null || echo "No rustc in Solana CLI"
        find ~/.local/share/solana -name "*rust*" -type f 2>/dev/null | head -10 || echo "No rust files in Solana CLI"
        
        # CHECK WHAT VERSIONS ARE IN SOLANA
        for rustc_path in $(find ~/.local/share/solana -name "rustc" -type f 2>/dev/null); do
          echo "Found Solana rustc at: $rustc_path"
          $rustc_path --version 2>/dev/null || echo "Failed to get version"
        done
        
        # NUCLEAR: Check anchor's internal paths
        echo "üîç CHECKING ANCHOR INTERNALS:"
        which anchor
        ls -la $(which anchor)
        
        # Check if anchor has internal solana tools
        anchor --version
        
        # FINAL NUCLEAR: RENAME/REMOVE the Solana CLI directory temporarily
        echo "üî• TEMPORARILY DISABLING SOLANA CLI..."
        mv ~/.local/share/solana ~/.local/share/solana_backup
        
        # Remove from PATH
        export PATH=$(echo $PATH | sed 's|[^:]*solana[^:]*:||g')
        source ~/.cargo/env
        export PATH="$HOME/.cargo/bin:$PATH"
        
        echo "üîç VERIFICATION WITHOUT SOLANA CLI:"
        which rustc
        rustc --version
        
        echo "üî® TRYING ANCHOR BUILD WITHOUT SOLANA CLI..."
        anchor build || echo "Build failed without Solana CLI"
        
        # If it fails, restore Solana CLI
        echo "üîÑ RESTORING SOLANA CLI..."
        mv ~/.local/share/solana_backup ~/.local/share/solana
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        echo "üéâ NUCLEAR DEPLOYMENT SUCCESSFUL!"
        
    - name: üìä Get Program ID
      run: |
        source ~/.cargo/env
        PROGRAM_ID=$(anchor keys list | grep spinza | awk '{print $2}')
        echo "üéâ SUCCESS! Program ID: $PROGRAM_ID"
        echo "PROGRAM_ID=$PROGRAM_ID" > deployment_info.txt
        
    - name: üéØ Initialize Game State
      run: |
        echo "Initializing game state..."
        
        # Set required environment variables for Anchor
        export ANCHOR_PROVIDER_URL="${{ github.event.inputs.environment == 'mainnet-beta' && 'https://api.mainnet-beta.solana.com' || 'https://api.devnet.solana.com' }}"
        export ANCHOR_WALLET="$HOME/.config/solana/id.json"
        
        echo "Using provider URL: $ANCHOR_PROVIDER_URL"
        echo "Using wallet: $ANCHOR_WALLET"
        
        # Check if IDL file exists
        echo "üîç Checking for IDL file..."
        ls -la target/idl/ || echo "No target/idl directory"
        ls -la target/idl/spinza.json || echo "spinza.json IDL not found"
        
        # If IDL doesn't exist, generate it
        if [ ! -f "target/idl/spinza.json" ]; then
          echo "üî® IDL file missing, generating it..."
          source ~/.cargo/env
          export PATH="$HOME/.cargo/bin:$PATH"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          
          # Generate IDL
          anchor build || echo "Build failed"
          
          # Check if IDL was created
          ls -la target/idl/spinza.json || echo "IDL still not found after build"
        else
          echo "‚úÖ IDL file found"
        fi
        
        # Install npm dependencies
        cd scripts
        npm install
        cd ..
        
        # Run initialization script
        node scripts/initialize.js
        
        echo "Game state initialized successfully!"
        
    - name: üì§ Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deployment_info.txt
