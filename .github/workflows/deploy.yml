name: ðŸš€ Deploy Spinza.io Smart Contract

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'devnet'
        type: choice
        options:
        - devnet
        - mainnet-beta

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
        
    - name: âš¡ Install Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.18.0/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        # Verify installation
        $HOME/.local/share/solana/install/active_release/bin/solana --version
        
    - name: âš“ Install Anchor CLI
      run: |
        npm install -g @coral-xyz/anchor-cli@0.30.0
        anchor --version
        
    - name: ðŸ”‘ Setup Solana Keypair
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        mkdir -p ~/.config/solana
        echo '${{ secrets.SOLANA_PRIVATE_KEY }}' > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        $HOME/.local/share/solana/install/active_release/bin/solana config set --url ${{ github.event.inputs.environment || 'devnet' }}
        echo "Using cluster: $($HOME/.local/share/solana/install/active_release/bin/solana config get | grep 'RPC URL')"
        
    - name: ðŸ’° Check and Fund Wallet
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        echo "Wallet address: $($HOME/.local/share/solana/install/active_release/bin/solana address)"
        echo "Current balance: $($HOME/.local/share/solana/install/active_release/bin/solana balance)"
        
        if [ "${{ github.event.inputs.environment || 'devnet' }}" = "devnet" ]; then
          echo "Requesting airdrop for devnet..."
          $HOME/.local/share/solana/install/active_release/bin/solana airdrop 2 || echo "Airdrop failed, continuing with existing balance"
          sleep 5
          echo "Balance after airdrop: $($HOME/.local/share/solana/install/active_release/bin/solana balance)"
        else
          echo "Mainnet deployment - ensure wallet has sufficient SOL"
        fi
        
    - name: ðŸ”¨ Build Smart Contract
      run: |
        echo "Building Spinza smart contract..."
        anchor build
        echo "Build completed successfully!"
        
    - name: ðŸš€ Deploy Smart Contract
      run: |
        echo "Deploying to ${{ github.event.inputs.environment || 'devnet' }}..."
        anchor deploy --provider.cluster ${{ github.event.inputs.environment || 'devnet' }}
        echo "Deployment completed!"
        
    - name: ðŸ“Š Verify Deployment
      run: |
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        PROGRAM_ID=$(anchor keys list | grep spinza | awk '{print $2}')
        echo "âœ… Smart Contract Deployed Successfully!"
        echo "ðŸ“ Program ID: $PROGRAM_ID"
        echo "ðŸŒ Network: ${{ github.event.inputs.environment || 'devnet' }}"
        echo "ðŸ’° Remaining balance: $($HOME/.local/share/solana/install/active_release/bin/solana balance)"
        
        $HOME/.local/share/solana/install/active_release/bin/solana program show $PROGRAM_ID
        
    - name: ðŸŽ¯ Initialize Game State
      run: |
        echo "Initializing game state..."
        cd scripts
        npm install
        node initialize.js
        echo "Game state initialized successfully!"
        
    - name: ðŸ“‹ Deployment Summary
      run: |
        PROGRAM_ID=$(anchor keys list | grep spinza | awk '{print $2}')
        echo "ðŸŽ‰ DEPLOYMENT COMPLETE!"
        echo "=================================="
        echo "ðŸ“ Program ID: $PROGRAM_ID"
        echo "ðŸŒ Network: ${{ github.event.inputs.environment || 'devnet' }}"
        echo "ðŸ‘‘ Operator Wallet: E7Y3q3gNA8DKGrXydpCnv4cTQnbkzM1wx3maHqJDv7n6"
        echo "ðŸ’° Min Bet: 0.1 SOL"
        echo "ðŸ’° Max Bet: 100 SOL"
        echo "ðŸ‘¥ Max Players: 50"
        echo "ðŸ’¼ Commission: 10%"
        echo "=================================="
        
        echo "PROGRAM_ID=$PROGRAM_ID" > deployment_info.txt
        echo "NETWORK=${{ github.event.inputs.environment || 'devnet' }}" >> deployment_info.txt
        
    - name: ðŸ“¤ Upload Deployment Info
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: |
          deployment_info.txt
          target/idl/spinza.json
