name: 🚀 Deploy Spinza.io Smart Contract

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'devnet'
        type: choice
        options:
        - devnet
        - mainnet-beta

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🧹 NUCLEAR CLEAN
      run: |
        echo "🧹 NUCLEAR CLEAN - Removing EVERYTHING..."
        sudo apt-get remove -y rustc cargo || true
        sudo apt-get autoremove -y || true
        rustup self uninstall -y || true
        rm -rf ~/.rustup ~/.cargo /usr/local/cargo /usr/local/rustup || true
        sudo rm -rf /usr/bin/rustc /usr/bin/cargo || true
        
    - name: 🦀 NUCLEAR RUST INSTALL
      run: |
        echo "📦 NUCLEAR Rust installation..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.77.0 --profile minimal
        source ~/.cargo/env
        
        # FORCE update PATH globally
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
        echo 'export RUSTUP_HOME="$HOME/.rustup"' >> ~/.bashrc
        echo 'export CARGO_HOME="$HOME/.cargo"' >> ~/.bashrc
        source ~/.bashrc
        
        # Verify NUCLEAR installation
        ~/.cargo/bin/rustc --version
        ~/.cargo/bin/cargo --version
        
    - name: ⚡ Install Solana CLI
      run: |
        source ~/.cargo/env
        echo "Installing Solana CLI..."
        cd /tmp
        wget https://github.com/solana-labs/solana/releases/download/v1.18.0/solana-release-x86_64-unknown-linux-gnu.tar.bz2
        tar -xjf solana-release-x86_64-unknown-linux-gnu.tar.bz2
        mkdir -p ~/.local/share/solana/install/active_release
        cp -r solana-release/* ~/.local/share/solana/install/active_release/
        chmod +x ~/.local/share/solana/install/active_release/bin/*
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        ~/.local/share/solana/install/active_release/bin/solana --version
        
    - name: ⚓ Install Anchor CLI
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.cargo/bin:$PATH"
        npm install -g @coral-xyz/anchor-cli@0.30.0
        anchor --version
        
    - name: 🔑 Setup Solana Keypair
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        mkdir -p ~/.config/solana
        echo '${{ secrets.SOLANA_PRIVATE_KEY }}' > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        ~/.local/share/solana/install/active_release/bin/solana config set --url ${{ github.event.inputs.environment || 'devnet' }}
        
    - name: 💰 Fund Wallet
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        echo "Wallet: $(~/.local/share/solana/install/active_release/bin/solana address)"
        if [ "${{ github.event.inputs.environment || 'devnet' }}" = "devnet" ]; then
          ~/.local/share/solana/install/active_release/bin/solana airdrop 2 || echo "Airdrop failed"
          sleep 5
        fi
        
    - name: 🔨 NUCLEAR BUILD
      run: |
        source ~/.cargo/env
        export PATH="$HOME/.cargo/bin:$PATH"
        export RUSTUP_HOME="$HOME/.rustup"
        export CARGO_HOME="$HOME/.cargo"
        
        echo "🔍 FINAL VERIFICATION:"
        echo "rustc: $(which rustc) -> $(rustc --version)"
        echo "cargo: $(which cargo) -> $(cargo --version)"
        
        # NUCLEAR BUILD with explicit paths
        ~/.cargo/bin/cargo --version
        CARGO_NET_GIT_FETCH_WITH_CLI=true ~/.cargo/bin/cargo build --release --manifest-path programs/spinza/Cargo.toml
        
    - name: 🚀 Deploy Smart Contract (10000% NUCLEAR SOLUTION)
      run: |
        echo "🚀 DEPLOYING WITH 10000% NUCLEAR SOLUTION..."
        
        # STEP 1: Find the .so file EVERYWHERE
        echo "🔍 SEARCHING FOR ALL .so FILES:"
        find . -name "*.so" -type f | head -20
        
        # STEP 2: Find our specific spinza.so file
        SPINZA_SO=$(find . -name "spinza.so" -type f | head -1)
        
        if [ -z "$SPINZA_SO" ]; then
          echo "💀 FATAL: No spinza.so found anywhere!"
          echo "All .so files:"
          find . -name "*.so" -type f
          exit 1
        fi
        
        echo "✅ FOUND spinza.so at: $SPINZA_SO"
        
        # STEP 3: NUCLEAR - Copy to ALL possible locations
        echo "📋 COPYING TO ALL POSSIBLE LOCATIONS:"
        mkdir -p target/deploy
        mkdir -p target/release
        mkdir -p target/debug
        
        cp "$SPINZA_SO" target/deploy/spinza.so
        cp "$SPINZA_SO" target/release/spinza.so
        cp "$SPINZA_SO" target/debug/spinza.so
        
        echo "✅ COPIED TO ALL LOCATIONS"
        
        # STEP 4: Verify files exist
        echo "🔍 VERIFICATION:"
        ls -la target/deploy/spinza.so || echo "❌ Not in target/deploy"
        ls -la target/release/spinza.so || echo "❌ Not in target/release"
        
        # STEP 5: NUCLEAR DEPLOY - Try multiple methods
        echo "🚀 ATTEMPTING DEPLOYMENT..."
        
        # Method 1: Standard deploy
        if anchor deploy --provider.cluster ${{ github.event.inputs.environment || 'devnet' }}; then
          echo "✅ DEPLOYED WITH METHOD 1 (standard)"
        else
          echo "⚠️ METHOD 1 FAILED, TRYING METHOD 2..."
          
          # Method 2: Specify program file directly
          if anchor deploy --provider.cluster ${{ github.event.inputs.environment || 'devnet' }} --program-id $(anchor keys list | grep spinza | awk '{print $2}') target/deploy/spinza.so; then
            echo "✅ DEPLOYED WITH METHOD 2 (direct file)"
          else
            echo "⚠️ METHOD 2 FAILED, TRYING METHOD 3..."
            
            # Method 3: Use solana program deploy directly
            export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
            PROGRAM_ID=$(anchor keys list | grep spinza | awk '{print $2}')
            
            if $HOME/.local/share/solana/install/active_release/bin/solana program deploy target/deploy/spinza.so --program-id $PROGRAM_ID; then
              echo "✅ DEPLOYED WITH METHOD 3 (solana direct)"
            else
              echo "💀 ALL METHODS FAILED!"
              echo "Final debug info:"
              ls -la target/deploy/
              anchor keys list
              exit 1
            fi
          fi
        fi
        
        echo "🎉 DEPLOYMENT SUCCESSFUL!"
        
    - name: 📊 Get Program ID
      run: |
        source ~/.cargo/env
        PROGRAM_ID=$(anchor keys list | grep spinza | awk '{print $2}')
        echo "🎉 SUCCESS! Program ID: $PROGRAM_ID"
        echo "PROGRAM_ID=$PROGRAM_ID" > deployment_info.txt
        
    - name: 🎯 Initialize Game
      run: |
        cd scripts
        npm install
        node initialize.js
        
    - name: 📤 Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deployment_info.txt
